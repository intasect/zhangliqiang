/*
  This class has been generated by the Code Generator
*/

package com.laiyifen.shop;

import java.text.SimpleDateFormat;
import java.util.Date;

import com.cordys.cpc.bsf.busobject.BSF;
import com.cordys.cpc.bsf.busobject.BusObjectConfig;
import com.cordys.cpc.bsf.busobject.BusObjectIterator;
import com.cordys.cpc.bsf.busobject.BusObjectManager;
import com.cordys.cpc.bsf.busobject.QueryObject;
import com.cordys.cpc.bsf.event.AccessMode;
import com.cordys.cpc.bsf.event.AfterAttributeChangeEvent;
import com.cordys.cpc.bsf.event.AttributeAccessEvent;
import com.cordys.cpc.bsf.event.AttributeInitializeEvent;
import com.cordys.cpc.bsf.event.BeforeCommitObjectEvent;
import com.laiyifen.common.core.APPROVAL_HISTORY;
import com.laiyifen.common.core.ATTACHMENT;
import com.laiyifen.common.core.User;
import com.laiyifen.common.util.BusObjectHelper;
import com.eibus.util.logger.CordysLogger;
import com.eibus.util.logger.Severity;


public class SHOP_MONTHLY_PLAN extends SHOP_MONTHLY_PLANBase
{
	private static CordysLogger logger = CordysLogger.getCordysLogger(SHOP_MONTHLY_PLAN.class);
	
	private User userObj = null;
	
    public SHOP_MONTHLY_PLAN()
    {
        this((BusObjectConfig)null);
    }

    public SHOP_MONTHLY_PLAN(BusObjectConfig config)
    {
        super(config);
    }
    
    public User getCurrUserInfo()
    {
    	if( this.userObj==null)
    	{
    		this.userObj= User.getUserInfo();
    	}
    	
    	return this.userObj;

    }
    
    public void onBeforeInsert() {
    	String formID = this.getFORM_ID();
		if (this.getFORM_ID()== null || this.getFORM_ID().equals("")) {
			this.setFORM_ID(formID);
		}
		
		if(this.getUSER_NAME()== null ||this.getUSER_NAME().equals("")){
			this.setUSER_NAME(User.getUserInfo().getUserName());
		}
    }
    @SuppressWarnings({ "unchecked", "static-access" })
	@Override
    public void onBeforeCommit(BeforeCommitObjectEvent event) {

    	super.onBeforeCommit(event);
    	
    	BusObjectIterator<APPROVAL_HISTORY> approvalHistoryObjects = this.getObjectManager().getObjects(BusObjectManager.SCOPE_TRANSACTION).getObjectsByType(APPROVAL_HISTORY.class);
    	while(approvalHistoryObjects.hasMoreElements())
    	{
    		APPROVAL_HISTORY approvalHistoryObject = (APPROVAL_HISTORY)approvalHistoryObjects.nextElement();
    		approvalHistoryObject.setAttributeValueIntegrity(this, this.ATTR_FORM_ID, APPROVAL_HISTORY.ATTR_FORM_ID);
    	}
    	
    	BusObjectIterator<ATTACHMENT> attachmentObjects = this.getObjectManager().getObjects(BusObjectManager.SCOPE_TRANSACTION).getObjectsByType(ATTACHMENT.class);
    	while(attachmentObjects.hasMoreElements())
    	{
    		ATTACHMENT attachmentObject = (ATTACHMENT)attachmentObjects.nextElement();
    		attachmentObject.setAttributeValueIntegrity(this, this.ATTR_FORM_ID, ATTACHMENT.ATTR_FORM_ID);
    	}
    }
    
    public static BusObjectIterator<com.laiyifen.shop.SHOP_MONTHLY_PLAN> getSelectShopMothlyPlanObjects(String year, String department_code, String subcompany_code, String user_name, com.cordys.cpc.bsf.query.Cursor cursor)
    {
    	logger.log(Severity.INFO, "getSelectShopMothlyPlanObjects--查询网点月度计划--开始", null);
    	
    	StringBuffer strBuf = new StringBuffer();
    	strBuf.append("select * from \"SHOP_MONTHLY_PLAN\" where 1=1 ");
        if (null != com.laiyifen.common.core.User.getUserInfo().getCompanyCode() && "1000".equals(com.laiyifen.common.core.User.getUserInfo().getCompanyCode()))
        {
        	strBuf.append("and \"STATUS\" <> 0  ");
        }
        else
        {
        	strBuf.append("and \"USER_CODE\" = :user_code ");
        }
        
        if (null != year && !("".equals(year)) && "" != year)
        {
        	strBuf.append("and \"YEAR\" = :year ");
        }
        if (null != department_code && !("".equals(department_code)) && "" != department_code)
        {
        	strBuf.append("and \"DEPARTMENT_CODE\" = :department_code "); 
        }
        if (null != subcompany_code && !("".equals(subcompany_code)) && "" != subcompany_code)
        {
        	strBuf.append("and \"SUBCOMPANY_CODE\" = :subcompany_code ");
        }
//        if (null != user_name && !("".equals(user_name)) && "" != user_name)
//        {
//        	strBuf.append("and \"USER_NAME\" = :user_name");
//        }
        
        QueryObject query = new QueryObject(strBuf.toString());
        
        if (null != year && !("".equals(year)) && "" != year)
        {
        	 query.addParameter("year", "SHOP_MONTHLY_PLAN.YEAR", QueryObject.PARAM_STRING, year);
        }
        if (null != department_code && !("".equals(department_code)) && "" != department_code)
        {
        	 query.addParameter("department_code", "SHOP_MONTHLY_PLAN.DEPARTMENT_CODE", QueryObject.PARAM_STRING, department_code);
        }
        if (null != subcompany_code && !("".equals(subcompany_code)) && "" != subcompany_code)
        {
        	 query.addParameter("subcompany_code", "SHOP_MONTHLY_PLAN.DEPARTMENT_CODE", QueryObject.PARAM_STRING, subcompany_code);
        }
//        if (null != user_name && !("".equals(user_name)) && "" != user_name)
//        {
//        	 query.addParameter("user_name", "SHOP_MONTHLY_PLAN.USER_NAME", QueryObject.PARAM_STRING, user_name);
//        }

        //query.addParameter("fromFORM_ID", "SHOP_MONTHLY_PLAN.FORM_ID", QueryObject.PARAM_STRING, fromFORM_ID);
        //query.addParameter("toFORM_ID", "SHOP_MONTHLY_PLAN.FORM_ID", QueryObject.PARAM_STRING, toFORM_ID);
        
        if (null != com.laiyifen.common.core.User.getUserInfo().getCompanyCode() && !("1000".equals(com.laiyifen.common.core.User.getUserInfo().getCompanyCode())))
        {
        	query.addParameter("user_code", "SHOP_MONTHLY_PLAN.USER_CODE", QueryObject.PARAM_STRING, com.laiyifen.common.core.User.getUserInfo().getUserCode());
        }
        
        
        query.setResultClass(SHOP_MONTHLY_PLAN.class);
        query.setCursor(cursor);
        
        logger.log(Severity.INFO, "getSelectShopMothlyPlanObjects--查询网点月度计划--结束", null);
        
        return query.getObjects();
    }
    
    public static void deleteShopMothlyPlanObject(String formId)
    {
    	logger.log(Severity.INFO, "deleteShopMothlyPlanObject--网点月度计划草稿删除--开始", null);

    	BusObjectIterator<ATTACHMENT> attachmentObj = ATTACHMENT
		.getAttachment(formId);
		if (attachmentObj != null) {
			while (attachmentObj.hasMoreElements()) {
				ATTACHMENT attachmentInfo = (ATTACHMENT) attachmentObj
						.nextElement();
				attachmentInfo.delete();
				//BusObjectHelper.unlinkChildren(attachmentInfo, ATTACHMENT.class);
			}
		}
		
		BusObjectIterator<APPROVAL_HISTORY> approvalHistoryObj = APPROVAL_HISTORY
				.getApprovalHistory(formId);
		if (approvalHistoryObj != null) {
			while (approvalHistoryObj.hasMoreElements()) {
				APPROVAL_HISTORY approvalHistoryInfo = (APPROVAL_HISTORY) approvalHistoryObj
						.nextElement();
				approvalHistoryInfo.delete();
			}
		}
		
		SHOP_MONTHLY_PLAN shopMonthlyPlan = SHOP_MONTHLY_PLAN.getShopMonthlyPlanObject(formId);
		shopMonthlyPlan.delete();
		
		logger.log(Severity.INFO, "deleteShopMothlyPlanObject--网点月度计划草稿删除--结束", null);
    }

    
    /*
     * 控制是否修改.
     */
    public void onDisplay_USER_NAME(AttributeAccessEvent context){
    	context.setAccess(AccessMode.READONLY);
    }
    /*
     * 输入框改变时，给提示信息.
     */
    public void onAfterChange_CITY(AfterAttributeChangeEvent event)
    {
    	//this.setCITY("This is shanghai city");
    }
    /*
     * 初始化用户信息
     */
    // 用户姓名
    public void onInitialize_USER_NAME(AttributeInitializeEvent context){
    	context.setInitialValue(this.getCurrUserInfo().getUserName());
    }
    //用户代码
    public void onInitialize_USER_CODE(AttributeInitializeEvent context){
    	context.setInitialValue(this.getCurrUserInfo().getUserCode());
    }
    //部门名称
    public void onInitialize_DEPARTMENT_NAME(AttributeInitializeEvent context){
    	context.setInitialValue(this.getCurrUserInfo().getDeptName());
    }
    //部门代码
    public void onInitialize_DEPARTMENT_CODE(AttributeInitializeEvent context){
    	context.setInitialValue(this.getCurrUserInfo().getDeptCode());
    }
    
    //子公司代码
    public void onInitialize_SUBCOMPANY_CODE(AttributeInitializeEvent context){
    	context.setInitialValue(this.getCurrUserInfo().getCompanyCode());
    }
	//子公司名称
    public void onInitialize_SUBCOMPANY_NAME(AttributeInitializeEvent context){
    	context.setInitialValue(this.getCurrUserInfo().getCompanyName());
    }
    
    
    //创建时间
    public void onInitialize_APPLICATION_DATE(AttributeInitializeEvent context){
    	SimpleDateFormat sDateFormat = new SimpleDateFormat("yyyy-MM-dd");      
    	String date = sDateFormat.format(new Date());
    	context.setInitialValue(date);
    }

}
